/*
 * ssd1306.c
 *
 *  Created on: 28.12.2017
 *      Author: Mateusz
 */

#include "ssd1306.h"
#include "stm32f1xx.h"

#include "FreeRTOS.h"
#include "task.h"
#include "queue.h"
#include "semphr.h"

#include "string.h"
#include "font.h"

SemaphoreHandle_t *i2c_semaphore;


typedef struct{
	uint8_t address;
	uint8_t adr;
	uint8_t *buf;
	uint16_t size;
} i2c_datatype;

volatile i2c_datatype I2C_data;

uint8_t ssd1306_buf[SSD1306_LCDWIDTH * (SSD1306_LCDHEIGHT / 8)] = { 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40,
		0xC0, 0xC0, 0xC0, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0,
		0xC0, 0xC0, 0xC0, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0,
		0xC0, 0xC0, 0xC0, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0xC0, 0xC0, 0xE0,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x41, 0xF1, 0xFF, 0x4F, 0x41, 0x41, 0x41, 0x41, 0x41,
		0x01, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0x00, 0x80, 0x60, 0x20, 0xF0, 0xF0, 0x00, 0x80,
		0xC0, 0x60, 0x30, 0xF0, 0xF0, 0x00, 0x00, 0x00, 0x80, 0xFC, 0x7F, 0x00, 0x10, 0x30, 0x30,
		0xE0, 0xC0, 0x40, 0x40, 0x40, 0xC0, 0x60, 0x20, 0x10, 0x10, 0x90, 0xF0, 0x60, 0x00, 0x00,
		0x00, 0xC0, 0xE0, 0x20, 0x10, 0x10, 0x10, 0x30, 0xA0, 0xF8, 0x3F, 0x00, 0x00, 0x00, 0x00,
		0x00, 0xC0, 0xE0, 0x20, 0x10, 0x10, 0x10, 0x30, 0xA0, 0xF8, 0x3F, 0x00, 0x00, 0x00, 0x00,
		0x00, 0xC0, 0x60, 0x20, 0x10, 0x10, 0x90, 0xF0, 0x60, 0x00, 0x00, 0x00, 0xC0, 0xE0, 0x20,
		0x10, 0x10, 0x10, 0x30, 0xA0, 0xF8, 0x3F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1E,
		0x3F, 0x30, 0x30, 0x30, 0x30, 0x30, 0x10, 0x08, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x3F, 0x0D,
		0x03, 0x00, 0x00, 0x3C, 0x3F, 0x0B, 0x06, 0x01, 0x00, 0x00, 0x1E, 0x3F, 0x30, 0x30, 0x18,
		0x0C, 0x0F, 0x1F, 0x30, 0x20, 0x20, 0x30, 0x18, 0x0F, 0x03, 0x00, 0x00, 0x0F, 0x1F, 0x3A,
		0x32, 0x31, 0x31, 0x11, 0x18, 0x08, 0x0C, 0x06, 0x1F, 0x3F, 0x30, 0x30, 0x18, 0x0C, 0x06,
		0x03, 0x1F, 0x3F, 0x30, 0x10, 0x18, 0x0C, 0x06, 0x1F, 0x3F, 0x30, 0x30, 0x18, 0x0C, 0x06,
		0x03, 0x1F, 0x3F, 0x30, 0x10, 0x18, 0x0C, 0x06, 0x0F, 0x1F, 0x3A, 0x32, 0x31, 0x31, 0x11,
		0x18, 0x08, 0x0C, 0x06, 0x1F, 0x3F, 0x30, 0x30, 0x18, 0x0C, 0x06, 0x03, 0x1F, 0x3F, 0x30,
		0x10, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x40, 0x40, 0x40,
		0x40, 0x40, 0xC0, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x30, 0x60, 0x60, 0xE0, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80,
		0x80, 0x80, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0x40, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x06, 0x03, 0x01, 0xE0, 0xFE, 0x0E, 0x30, 0x70, 0xF0, 0x98, 0x08, 0x07, 0x03, 0x00, 0x00,
		0xC0, 0xF0, 0x98, 0x88, 0x44, 0x44, 0x64, 0x3C, 0x18, 0x00, 0x80, 0xC0, 0xF0, 0x38, 0x08,
		0x04, 0x04, 0x84, 0x4C, 0xF8, 0xFC, 0x0C, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xFE, 0x1F,
		0x00, 0x00, 0x00, 0x80, 0x40, 0xB0, 0xF8, 0x39, 0x01, 0x00, 0x00, 0x80, 0xC2, 0xE2, 0xFE,
		0x1F, 0x03, 0x02, 0x02, 0x02, 0x02, 0x0A, 0x1A, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0xE0, 0x20,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1C, 0x1F, 0x01, 0x00, 0x00,
		0x00, 0x01, 0x07, 0x0E, 0x0C, 0x0C, 0x06, 0x00, 0x03, 0x07, 0x0E, 0x0C, 0x0C, 0x0C, 0x04,
		0x06, 0x02, 0x03, 0x01, 0x07, 0x0F, 0x0C, 0x0C, 0x06, 0x03, 0x01, 0x00, 0x03, 0x07, 0x06,
		0x06, 0x03, 0x01, 0x01, 0x00, 0x07, 0x0F, 0x0C, 0x0C, 0x06, 0x03, 0x01, 0x00, 0x07, 0x0F,
		0x0C, 0x0C, 0x06, 0x03, 0x01, 0x00, 0x07, 0x0F, 0x0C, 0x0C, 0x04, 0x86, 0x81, 0x80, 0x80,
		0xC0, 0x60, 0x37, 0x1F, 0x06, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, };



void ssd1306_task(){
	uint8_t vccstate = SSD1306_SWITCHCAPVCC;
	uint8_t refresh = SSD1306_REFRESH_MID;

	ssd1306_command(SSD1306_DISPLAYOFF); // 0xAE
	ssd1306_command(SSD1306_SETDISPLAYCLOCKDIV); // 0xD5
	ssd1306_command(refresh); // the suggested ratio 0x80
	ssd1306_command(SSD1306_SETMULTIPLEX); // 0xA8
	ssd1306_command(0x3F);
	ssd1306_command(SSD1306_SETDISPLAYOFFSET); // 0xD3
	ssd1306_command(0x0); // no offset
	ssd1306_command(SSD1306_SETSTARTLINE | 0x0); // line #0
	ssd1306_command(SSD1306_CHARGEPUMP); // 0x8D
	if (vccstate == SSD1306_EXTERNALVCC) {
		ssd1306_command(0x10);
	} else {
		ssd1306_command(0x14);
	}
	ssd1306_command(SSD1306_MEMORYMODE); // 0x20
	ssd1306_command(0x00); // 0x0 act like ks0108
	ssd1306_command(SSD1306_SEGREMAP | 0x1);
	ssd1306_command(SSD1306_COMSCANDEC);
	ssd1306_command(SSD1306_SETCOMPINS); // 0xDA
	ssd1306_command(0x12);
	ssd1306_command(SSD1306_SETCONTRAST); // 0x81
	if (vccstate == SSD1306_EXTERNALVCC) {
		ssd1306_command(0x9F);
	} else {
		ssd1306_command(0xCF);
	}
	ssd1306_command(SSD1306_SETPRECHARGE); // 0xd9
	if (vccstate == SSD1306_EXTERNALVCC) {
		ssd1306_command(0x22);
	} else {
		ssd1306_command(0xF1);
	}
	ssd1306_command(SSD1306_SETVCOMDETECT); // 0xDB
	ssd1306_command(0x40);
	ssd1306_command(SSD1306_DISPLAYALLON_RESUME); // 0xA4
	ssd1306_command(SSD1306_NORMALDISPLAY); // 0xA6

	ssd1306_command(SSD1306_DISPLAYON);

	for(;;){
//		ssd1306_clear_screen();
//		ssd1306_draw_string("KURWA", 20,4);
		ssd1306_display();
//		GPIOA->ODR ^= GPIO_PIN_5;
		vTaskDelay(100 / portTICK_RATE_MS);
//		ssd1306_clear_screen();
//		ssd1306_draw_string("KURWA", 20,4);

	}
}

void ssd1306_initialize() {
	// create binary semaphore
	i2c_semaphore = xSemaphoreCreateBinary();


	RCC->APB1ENR |= RCC_APB1ENR_I2C1EN;
	RCC->APB2ENR |= RCC_APB2ENR_IOPBEN;
	RCC->APB2ENR |= RCC_APB2ENR_AFIOEN;

	AFIO->MAPR |= AFIO_MAPR_I2C1_REMAP;	// pin remap

	GPIOB->CRH |= GPIO_CRH_MODE9_1 | GPIO_CRH_MODE9_0 | GPIO_CRH_CNF9_1 | GPIO_CRH_CNF9_0;	//pb9 as alt opendrain
	GPIOB->CRH |= GPIO_CRH_MODE8_1 | GPIO_CRH_MODE8_0 | GPIO_CRH_CNF8_1 | GPIO_CRH_CNF8_0;	//pb8 as alt opendrain

	// i2c initialize
	I2C1->CCR |= I2C_CCR_FS | I2C_CCR_DUTY;
	I2C1->CCR |= ( 45 & I2C_CCR_CCR );		// 400mhz

	I2C1->CR2 |= I2C_CR2_ITEVTEN;// | I2C_CR2_ITBUFEN;
	I2C1->CR2 |= (8 & I2C_CR2_FREQ);	// periph clock freq is 36mhz
	// maybe TRISE bits??

	I2C1->CR1 |= I2C_CR1_PE;	// i2c1 enable

	// todo ssd1306 initialize


	NVIC_ClearPendingIRQ(I2C1_EV_IRQn);
	NVIC_EnableIRQ(I2C1_EV_IRQn);
	NVIC_SetPriority(I2C1_EV_IRQn, 6);

	xSemaphoreGive(i2c_semaphore);
}

void ssd1306_display(void) {
	ssd1306_command(SSD1306_SETSTARTLINE | 0x00);
	ssd1306_command(SSD1306_SETLOWCOLUMN | 0x00);
	ssd1306_command(SSD1306_SETHIGHCOLUMN | 0x00);

	i2c_write_buf(SSD1306_I2C_ADRESS, 0x40, ssd1306_buf, SSD1306_LCDWIDTH * (SSD1306_LCDHEIGHT / 8) );
}

void ssd1306_clear_screen() {
	memset(ssd1306_buf, 0, SSD1306_LCDWIDTH * (SSD1306_LCDHEIGHT / 8));
}

void ssd1306_command(uint8_t command) {
	i2c_write_buf(SSD1306_I2C_ADRESS, 0x00, &command, 1);

}

void ssd1306_draw_string(const char *string, uint8_t x, uint8_t y) {
	while (*string) {
		if (*string == ' ') {
			x += 4;
		} else {
			for (uint8_t i = 0; i < 5; i++) {
				uint8_t str = font_minecraftia[*string - font_minecraftia_offset][i];
				if (str) {
					ssd1306_buf[x++] = str;
				} else
					break;
			}
		}
		x++;
		string++;
	}
}

void i2c_write_buf(uint8_t addres, uint8_t adr, uint8_t *buf, uint16_t size) {
	while (xSemaphoreTake(i2c_semaphore, 100 / portTICK_RATE_MS) != pdTRUE){}

//	if (xSemaphoreTake(i2c_semaphore, portMAX_DELAY) == pdTRUE){
		I2C_data.address = addres;
		I2C_data.adr = adr;
		I2C_data.buf = buf;
		I2C_data.size = size;

		I2C1->CR1 |= I2C_CR1_START;

		GPIOA->ODR ^= GPIO_PIN_5;
//	}
}


void i2c_write(uint8_t address, uint8_t adr, uint8_t data){
	i2c_write_buf(address, adr, &data, 1);

}


void I2C1_EV_IRQHandler(){
static int16_t ndata = -1;
portBASE_TYPE xHigherPriorityTaskWoken = pdFALSE;

	uint32_t status = I2C1->SR1;
	uint32_t stat = I2C1->SR2;

	if (status & I2C_SR1_SB) {	// when start bit transmited
		I2C1->DR = I2C_data.address;	// put address into  DR to transmit


	} else if(status & I2C_SR1_ADDR){	// when adress transmited
		ndata = 0;
		I2C1->DR = I2C_data.adr;	// put first byte of data into DR

	} else if (status & I2C_SR1_BTF) {	//when prev byte transmited
		if (ndata < I2C_data.size){			// and still theres data to send
			I2C1->DR = I2C_data.buf[ndata];	// put data into transfer register
//			if (ndata == I2C_data.size - 1) {	//when last byte is being transmited
//				I2C1->CR1 |= I2C_CR1_STOP; 	//  send stop bit after transmiting this byte
//			}
			ndata++;

		} else {				// when all data transmited
			ndata = -1;
			// todo stop transmision
			// todo release periph
			I2C1->CR1 |= I2C_CR1_STOP; 	//  send stop bit after transmiting this byte
			while( I2C1->CR1 & I2C_CR1_STOP ){}
			xSemaphoreGiveFromISR(i2c_semaphore, &xHigherPriorityTaskWoken);

		}

	} else {
		uint16_t st = I2C1->SR1;
	}

	portYIELD_FROM_ISR(xHigherPriorityTaskWoken);
}
